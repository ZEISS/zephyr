# SPDX-FileCopyrightText: Copyright (c) 2024 Carl Zeiss Meditec AG
# SPDX-License-Identifier: Apache-2.0

description: Analog Devices TMC5041 Stepper Motor Controller

compatible: "adi,tmc5041"

include:
  - name: spi-device.yaml
  - name: adi,trinamic-gconf.yaml
    property-allowlist:
      - poscmp_enable
      - shaft1
      - shaft2
      - test_mode
      - lock_gconf

properties:
  "#address-cells":
    default: 1
    const: 1

  "#size-cells":
    default: 0
    const: 0

  clock-frequency:
    type: int
    required: true
    description: |
      The frequency of the clock signal provided to the TMC5041.
      This is used for real world conversion.

      Hint: µstep velocity v[Hz] µsteps / s v[Hz] = v[5041] * ( fCLK[Hz]/2 / 2^23 )
            where v[5041] is the value written to the TMC5041.

child-binding:
  properties:
    stallguard-threshold:
      type: int
      default: 0
      description: |
        This signed value controls StallGuard2 level for stall  output and sets the
        optimum measurement range for readout. A lower value gives a higher sensitivity.
        Zero is the starting value working with most motors.

        -64 to +63: A higher value makes StallGuard2 less sensitive and requires more torque
        to indicate a stall.

    stallguard-threshold-velocity:
      type: int
      default: 0
      description: |
        Threshold velocity for StallGuard2 to detect a stall event.
        Setting this property to a non-zero value activates stallguard detection in the driver.

    stallguard-activation-delay-ms:
      type: int
      default: 0
      description: |
        Stallguard activation delay in ms.
        Stallguard should not be enabled during motor spin-up.
        This delay is also used to check if stepper velocity is greater than
        stallguard-threshold-velocity before enabling stallguard.

  include:
    - name: base.yaml
      property-allowlist:
        - reg
    - name: stepper-controller.yaml
      property-allowlist:
        - micro-step-res
    - name: adi,trinamic-ramp-generator.yaml
      property-allowlist:
        - vstart
        - a1
        - v1
        - amax
        - vmax
        - dmax
        - d1
        - vstop
        - tzerowait
        - vhigh
        - vcoolthrs
        - ihold
        - irun
        - iholddelay
